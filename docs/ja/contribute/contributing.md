# 貢献

> [!TIP]
>
> #### 新規issueの作成
>
> [issueの作成方法](./issues)を確認してください。

# Want to help?

協力していただけませんか？:
以下の分野での協力は特に歓迎されます。

- バグの報告。DDAから引き継いだバグも含む。
- バグではないが問題がある点の特定。誤解を招く説明、類似ケースと比較して明らかに不適切な値、文法上の誤
  り、明白な解決策があるUIの不具合など。
- 役に立たないものを有用にする、またはブラックリストに載せること。解体レシピを持つべきなのに持っていな
  いアイテムにレシピを追加する、スポーンリスト内で完全に冗長なアイテムをその汎用版（例えば「小さな目印付きボトル」を単なる「小さなボトル」に）置き換えること。
- タイルセットの作業。 新しい電線グリッド要素など、私が時折新しいオブジェクトを追加しており、それらには
  新しいタイルが必要です。
- バランス分析。 これらはかなり詳細であるか、「明らかに正しい」ものであるべきです。「明らかに正しい」例
  としては、「武器Xは武器Yよりも厳密に優れたステータスを持っているが、Yはより希少なコンポーネントを必要とし、その他の要件は同一である」といったケースです。
- プロファイラを用いたパフォーマンス上のボトルネックの特定。
- コード品質の向上。

## 貢献方法

Cataclysm: Bright Nightsへの貢献は簡単です:

1. GitHubで本リポジトリをフォークします。
2. 変更を加えます。
3. プルリクエスト(PR)を送信します。

> [!NOTE]
>
> #### ライセンス
>
> Cataclysm: Bright Nightsは、Creative Commons Attribution ShareAlike 3.0ライセンスのもとでリリース
> されています。ゲームのコードとコンテンツは、いかなる目的であれ、自由に使用、変更、再配布が可能です。詳細については、
> http://creativecommons.org/licenses/by-sa/3.0/ を参照してください。これは、あなたがプロジェクトに対して行ういかなる貢献も、同じライセンスの対象となり、このライセンスは撤回不能であることを意味します。

## ガイドライン

遵守することを推奨するいくつかのガイドラインがあります:

- 本リポジトリを`upstream`リモートとして追加してください
- メインブランチ（`main` branch）をクリーンに保ってください。これにより、本リポジトリに加えられた変更を、簡単に自分のリポジトリにプルできるようになります。
- 新しい機能や、関連するバグ修正のセットごとに、新しいブランチを作成してください。
- ローカルブランチから自分の `main` ブランチへマージすることは避けてください。
  `upstream/main`からプルすることによってのみ更新してください。

## コードスタイル

### C++

コードスタイルは、コードベース全体で `astyle` によって強制されています。詳細については、
[CODE_STYLE](./../dev/explanation/code_style.md) を参照してください。

### JSON

JSONファイルは、 `tools/format`で利用可能なカスタムフォーマッタを使用してフォーマットされます。詳細については、
[JSON スタイルガイド](./../mod/json/explanation/json_style.md) を参照してください。

### Markdown

`doc/` などのMarkdownファイルは、[`deno`](https://deno.com)の組み込みフォーマッタを使用してフォーマットされます。Markdownファイルをフォーマットするには、どこからでも
[`deno fmt`](https://deno.land/manual/tools/formatter) を実行してください。
VSCodeでは、保存時にMarkdownファイルを自動フォーマットするために、以下の設定を行うことができます:

```json
// .vscode/settings.json
{
  "[markdown]": {
    "editor.formatOnSave": true,
    "editor.defaultFormatter": "denoland.vscode-deno"
  }
}
```

### Lua

Luaファイルは、 [`dprint`](https://dprint.dev)の組み込みフォーマッタを使用してフォーマットされます。Luaファイルをフォーマットするには、どこからでも
[`deno task dprint fmt`](https://dprint.dev/plugins/lua) を実行してください。詳細については、 [Lua スタイルガイド](./../mod/lua/explanation/lua_style.md)を参照してください。

## 翻訳

Cataclysm: BNの翻訳はTransifexを使用して行われています。サポートされている言語の最新リストについては、
[翻訳プロジェクト](https://app.transifex.com/bn-team/cataclysm-bright-nights/)を参照してください。

詳細については、以下を参照してください:

- [For translators](./../i18n/tutorial/transifex)
- [For developers](./../i18n/reference/translation)
- [For maintainers](./../i18n/guides/maintain)

## ドキュメンテーション

<!--
![](./img/contributing-doxy1.png)
![](./img/contributing-doxy2.png)

Autogenerated documentation is hosted on
[GitHub Pages](https://cataclysmbnteam.github.io/Cataclysm-BN). -->

### Doxygenコメント

クラスとクラスメンバーを広範囲にわたってドキュメント化することで、新規貢献者にとってコードの可読性が向上します。既存のクラスに対する新しいDoxygenコメントは、歓迎される貢献です。

クラスをコメントアウトするには、以下のテンプレートを使用してください。

```cpp
/**
 * (簡潔な説明)
 *
 * 長文の説明（多くの単語を使用）。 (オプション)
 */
class foo {

}
```

関数をコメントアウトするには、以下のテンプレートを使用してください。

```cpp
/**
 * 簡潔な説明
 *
 * 長文の説明。 (オプション)
 * @param param1 の説明 (オプション)
 * @return 戻り値の説明 (オプション)
 */
int foo(int param1);
```

メンバー変数をコメントアウトするには、以下のテンプレートを使用してください。

```cpp
/** 簡潔な説明 **/
int foo;
```

### ドキュメンテーション追加のガイドライン

- Doxygenコメントは、外部に向けた振る舞いを説明すべきであり、実装については説明すべきではありませんが、
  Cataclysmの多くのクラスは絡み合っているため、実装の説明が必要になることもよくあります。
- 名前からでは新参者には明らかではない事柄を説明してください。
- 冗長な説明は避けてください。例: `/** Map **/; map* map;` は役立つコメントではありません。
- Xをドキュメント化する際は、X自体が何をするかだけでなく、Xが他のコンポーネントとどのように相互作用するかを説明してください。

### ローカルで表示するためのドキュメンテーションのビルド

- doxygenをインストールします
- `doxygen doxygen_doc/doxygen_conf.txt` を実行します
- `firefox doxygen_doc/html/index.html` を実行します (firefoxをお好みのブラウザに置き換えてください)

## ワークフローの例

### 環境のセットアップ

_(これは一度だけ実行する必要があります。)_

1. GitHubで本リポジトリをフォークします。

2. 自分のフォークをローカルにクローンします。

```sh
$ git clone https://github.com/YOUR_USERNAME/Cataclysm-BN.git
# 自分のフォークのリポジトリを、ターミナルのカレントディレクトリにクローンします
```

3. コミットメッセージのテンプレートを設定します。

```sh
$ git config --local commit.template .gitmessage
```

4. 本リポジトリをリモートとして追加します。

```sh
$ cd Cataclysm-BN
# プロンプトのアクティブディレクトリを、新しくクローンされた "Cataclysm-BN" ディレクトリに変更します
$ git remote add -f upstream https://github.com/cataclysmbnteam/Cataclysm-BN.git
# オリジナルリポジトリを "upstream" というリモートに割り当てます
```

コミットメッセージのガイドラインに関する詳細については、以下を参照してください:

- [codeinthehole.com](https://codeinthehole.com/tips/a-useful-template-for-commit-messages/)
- [chris.beams.io](https://chris.beams.io/posts/git-commit/)
- [help.github.com](https://help.github.com/articles/closing-issues-using-keywords/)

### メインブランチ `main` の更新

0. **自分の `main` ブランチが、originの `main` ではなく、upstream の `main` を追跡していることを、以下のコマンドで確認してください。**

```sh
$ git branch --set-upstream-to upstream/main main
# 自分のブランチ 'main' が upstream の main を追跡するように設定します。
```

自分の `main` が正しくアップストリームを指しているかを確認するには、 `git remote -v` と入力してください。以下のような出力が表示されるはずです。

```sh
$ git remote -v

origin  git@github.com:YOUR_USERNAME/Cataclysm-BN.git (fetch)
origin  git@github.com:YOUR_USERNAME/Cataclysm-BN.git (push)
upstream        https://github.com/cataclysmbnteam/Cataclysm-BN.git (fetch)
upstream        https://github.com/cataclysmbnteam/Cataclysm-BN.git (push)
```

そして、 `git branch -vv` と入力すると、`main` ブランチの横に `[upstream/main]` が表示されるはずです。

```sh
$ git branch -vv

# ...
* main   ed11439ee61 [upstream/main] feat: add more vending machines to marina (#7001)
# ...
```

1. `main` ブランチにいることを確認します。

```sh
$ git switch main
```

2. `upstream/main` ブランチから変更をプルします。

```sh
$ git pull --ff-only upstream main
# "upstream" リモートの "main" ブランチから変更を取得します
```

> **注記**これでエラーが発生した場合、それはローカルの `main`ブランチに直接コミットしたことを意味します。
> [この問題を解決する方法について、こちらをクリックしてください。](#why-does-git-pull---ff-only-result-in-an-error).

### 変更の作成

0. まだ更新していない場合は `main` ブランチを更新します。

1. 新しい機能またはバグ修正ごとに、新しいブランチを作成します。

```sh
$ git switch --create new_feature
# "new_feature" という新しいブランチを作成し、それをアクティブなブランチにします
```

2. ローカルでいくつかの変更をコミットしたら、GitHub上の自分のフォークにそれらをプッシュする必要があります。

```sh
$ git push origin new_feature
# クローンしたときに origin は自動的に自分のフォークを指すように設定されています
```

3. ブランチでの作業を終え、すべての変更をコミットしてプッシュしたら、自分の `new_feature` ブランチから本リポジトリの`main` ブランチに対してプルリクエストを送信します。

> **注記** GitHub上の `new_feature` ブランチへの新しいコミットは、自動的にプルリクエストに含まれるため、関連する変更のみを同じブランチにコミットするようにしてください。

## プルリクエストに関する注意点

PRを提出したが、まだ作業中の場合は
[draft](https://docs.github.com/en/pull-requests/collaborating-with-pull-requests/proposing-changes-to-your-work-with-pull-requests/about-pull-requests#draft-pull-requests)としてマークしてください。これにより、準備が整ったものだけをレビューし、完全に準備ができていないものがマージされるのを防ぐことができるため、レビュープロセスを迅速化できます。

PRを提出するために、未解決のIssueを解決または参照する必要はありませんが、参照する場合は、PRが解決しようとしている問題を完全に詳細に説明する必要があります。

### キーワードを使用したIssueのクローズ

もう一つ：PRをIssueのクローズ、修正、または解決としてマークする際は、説明のどこかに以下を含めてください:

```md
- {keyword} #{issue}
```

for example: `- fixed #12345`

### キーワード

`{keyword}` は次のいずれかである必要があります。

- `close`, `closes`, `closed`
- `fix`, `fixes`, `fixed`
- `resolve`, `resolves`, `resolved`

### issue

そして `{issue}` は、PRがマージされた後にクローズするIssueの番号です。

これにより、PRが取り込まれたときにIssueが自動的にクローズされ、マージの作業がわずかに迅速になります。

### 複数のIssueを一度にクローズする

```md
- {keyword} #{issue}, {keyword} #{issue}
```

詳細については、 https://help.github.com/articles/closing-issues-using-keywords を参照してください。

## ツールのサポート

貢献内容が適切なスタイルに準拠していることを維持するために、さまざまなツールが利用可能です。詳細については、[開発ツール](./../dev/reference/tooling)を参照してください。

## 応用テクニック

これらのガイドラインは必須ではありませんが、物事を整理しておくのに非常に役立ちます。

### リモート追跡ブランチの使用

リモート追跡ブランチを使用すると、本リポジトリの `main` ブランチとの連携を簡単に維持できます。これは、どのリモートブランチから変更を取得すべきかを自動的に知っているためです。

```sh
$ git branch -vv
* main        xxxx [origin/main] ....
  new_feature xxxx ....
```

ここでは、2つのブランチがあることがわかります; `main` は `origin/main`を追跡しており、`new_feature`
はどのブランチも追跡していません。実際には、これはgitがどこから変更を取得すべきかわからないことを意味します。

```sh
$ git checkout new_feature
Switched to branch 'new_feature'
$ git pull
There is no tracking information for the current branch.
Please specify which branch you want to merge with.
```

`upstream/main`からの変更を `new_feature` ブランチに簡単にプルできるように、gitにどのブランチを追跡すべきかを伝えることができます (これはローカルのmainブランチにも設定できます)。

```sh
$ git branch -u upstream/main new_feature
Branch new_feature set up to track remote branch main from upstream.
$ git pull
Updating xxxx..xxxx
....
```

ブランチを作成すると同時に、追跡情報を設定することもできます。

```sh
$ git branch new_feature_2 --track upstream/main
Branch new_feature_2 set up to track remote branch main from upstream.
```

> **注記**: これにより`upstream/main`からのプルは簡単になりますが、プッシュに関しては何も変わりません。
> `upstream/main`へのプッシュ権限がないため、`git push` は失敗します。

```sh
$ git push
error: The requested URL returned error: 403 while accessing https://github.com/cataclysmbnteam/Cataclysm-BN.git
fatal: HTTP request failed
$ git push origin
....
To https://github.com/YOUR_USERNAME/Cataclysm-BN.git
xxxx..xxxx  new_feature -> new_feature
```

## ユニットテスト

tests/ には、ソースツリーに組み込まれたテストスイートがあります。ゲームソースにいかなる変更を加えた後も、テストスイートを実行する必要があります。通常の `make` の呼び出しにより、
tests/cata_testにテスト実行可能ファイルがビルドされ、通常の実行可能ファイルと同様に、または `make check`を介して呼び出すことができます。引数がない場合、テストスイート全体が実行されます。`--help` を使用すると、その操作を調整するために使用できる多くの呼び出しオプションが出力されます。

```sh
$ make
... compilation details ...
$ tests/cata_test
Starting the actual test at Fri Nov  9 04:37:03 2018
===============================================================================
All tests passed (1324684 assertions in 94 test cases)
Ended test at Fri Nov  9 04:37:45 2018
The test took 41.772 seconds
```

私は、 `make YOUR BUILD OPTIONS && make check`のように、make を習慣的に呼び出すことを推奨します。

## ゲーム内テスト、テスト環境、およびデバッグメニュー

新しい機能を実装している場合でも、バグを修正している場合でも、ゲーム内で変更をテストすることは常に良い習慣です。通常のゲームをプレイして、変更をテストできる正確な条件を作り出すのは難しい作業になる可能性があるため、デバッグメニューがあります。このメニューを呼び出すためのデフォルトキーはないため、まずキーを割り当てる必要があります。

キーバインディングメニューを呼び出し ( `Escape` キーを押してから `1`)、ほぼ一番下までスクロールして
`+` を押して新しいキーバインドを追加します。_デバッグメニュー_アイテムに対応する文字を押し、次にデバッグメニューを呼び出すために使用したいキーを押します。変更をテストするには、新しいキャラクターで新しいワールドを作成します。そのワールドに入ったら、デバッグメニューに割り当てたキーを押すと、次のような画面が表示されるはずです:

```
┌─────────────────────────────────────────────────────┐
│ デバッグ機能 - 現実の構造を操作！                   │
├─────────────────────────────────────────────────────┤
│ i 情報                                              │
│ Q メインメニューへ終了                              │
│ s スポーン...                                       │
│ p プレイヤー...                                     │
│ t テレポート...                                     │
│ m マップ...                                         │
└─────────────────────────────────────────────────────┘
```

これらのコマンドを使用すると、変更をテストするための適切な条件を再現できるはずです。デバッグメニューに関する有用な情報は、
[DDA wiki](http://cddawiki.chezzo.com/cdda_wiki/index.php) にあるかもしれません。

## よくある質問

### なぜ `git pull --ff-only` でエラーが発生するのですか？

`git pull --ff-only` でエラーが表示される場合、それはローカルの `main`ブランチに直接コミットしたことを意味します。これを修正するには、これらのコミットを含む新しいブランチを作成し、 `upstream/main`から分岐したポイントを見つけて、そのポイントに `main` をリセットします。

```sh
$ git pull --ff-only upstream main
From https://github.com/cataclysmbnteam/Cataclysm-BN
 * branch            main     -> FETCH_HEAD
fatal: Not possible to fast-forward, aborting.
$ git branch new_branch main          # 現在のコミットを一時ブランチでマークします
$ git merge-base main upstream/main
cc31d0... # main に直接コミットする前の最後のコミット
$ git reset --hard cc31d0....
HEAD is now at cc31d0... ...
```

これで `main` がクリーンアップされたので、`upstream/main`から簡単にプルし、`new_branch`での作業を続行できます。

```sh
$ git pull --ff-only upstream main
# gets changes from the "upstream" remote for the matching branch, in this case "main"
$ git checkout new_branch
```

その他のよくある質問については、[developer FAQ](./../dev/reference/faq.md)を参照してください。

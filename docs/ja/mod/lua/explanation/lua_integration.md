# C++とLuaの統合

このドキュメントでは、Cataclysm: Bright NightsにおけるLua統合機能の実装詳細について説明します。

BNはスクリプト実行にLua 5.3.6を使用し、C++側のバインディングにはsol2 v3.3.0を利用しています。

## C++ レイアウト

### Lua ソースファイル

ビルド設定を簡素化し、移植性の向上のため、`Lua 5.3.6` のソースコードを `src/lua/`ディレクトリにバンドルし、ビルドシステムがこれをコンパイルしてゲーム実行ファイルおよびテスト用のライブラリにリンクするようにしています。

### Sol2 ソースファイル

Sol2はバンドルが容易です。`sol2 v3.3.0` のシングルヘッダーを連結したバージョンを `src/sol/`
に配置し、必要に応じてインクルードしています。このヘッダーは非常に大きいため、インクルードするソースファイルは少ない方が望ましいです。

- `sol/config.hpp` - 設定ヘッダー。ここでいくつかのオプションを定義しています。
- `sol/forward.hpp` - 前方宣言用。軽量なヘッダーであり、ゲームのヘッダーファイルでは
  `sol/sol.hpp`の代わりにこちらをインクルードすべきです
- `sol/sol.hpp` - メインのsol2ヘッダーファイル。非常に大きいため、ゲームのヘッダーファイルでのインクルードは避けてください。

### ゲーム ソースファイル

Luaに関連するゲームのソースファイルはすべて `catalua` の接頭辞を持っています。

新しいバインディングを追加したい場合は、`src/catalua_bindings.cpp`の既存の例を参照し、Sol2のドキュメントの関連セクションを読むことを検討してください。

- `catalua.h` (および `catalua.cpp`) - メインのLuaインターフェース。ほとんどのコードベースがインクルードする必要がある唯一のヘッダーであり、パブリックインターフェースを提供します。
- `catalua_sol.h` と `catalua_sol_fwd.h` - `sol/sol.hpp` と `sol/forward.hpp` のラッパーであり、コンパイルさせるためのカスタムプラグマが含まれています。
- `catalua_bindings*` - ゲームのLuaバインディングが格納されます。
- `catalua_console.h`(`.cpp`) - ゲーム内のLuaコンソール。
- `catalua_impl.h`(`.cpp`) - `catalua.h`(`.cpp`)の実装詳細。
- `catalua_iuse_actor.h`(`.cpp`) - Luaによって駆動される `iuse_actor`。
- `catalua_log.h`(`.cpp`) - コンソール用のインメモリロギング。
- `catalua_luna.h` - 自動ドキュメント生成機能を備えたユーザー型登録インターフェース。別名 `luna`。
- `catalua_luna_doc.h` - `luna` を通じて登録された、またはそのドキュメントジェネレータに公開される型のリスト。
- `catalua_readonly.h`(`.cpp`) - Luaテーブルを読み取り専用としてマークするための関数。
- `catalua_serde.h`(`.cpp`) - LuaテーブルとJSON間のシリアライズとデシリアライズ（相互変換）。
- `catalua_type_operators.h` - `string_ids`のバインディング実装を支援するマクロ。
